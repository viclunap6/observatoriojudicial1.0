<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Evaluar Jueces - Misjueces.mx</title>
        <link rel="stylesheet" href="assets/css/styles.css" />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body>
        <!-- Evaluar Section -->
        <section class="evaluar-section">
            <div class="container">
                <h2 data-animation="fade-in">Evaluar Juez</h2>

                <form id="evaluationForm">
                    <div class="form-group">
                        <label for="ratingSlider">Calificación:</label>
                        <input
                            type="range"
                            id="ratingSlider"
                            min="1"
                            max="10"
                            value="5"
                        />
                    </div>

                    <div class="form-group">
                        <label for="commentsInput"
                            >Comentarios (50-500 caracteres):</label
                        >
                        <textarea id="commentsInput" maxlength="500"></textarea>
                    </div>

                    <button type="submit" data-animation="magnetic-hover">
                        Enviar Evaluación
                    </button>
                </form>

                <canvas id="evaluationChart" width="400" height="400"></canvas>
            </div>
        </section>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                gsap.to(".evaluar-section", {
                    duration: 2,
                    opacity: 1,
                    ease: "power4.out",
                    delay: 0.3,
                });

                document
                    .querySelectorAll("[data-animation]")
                    .forEach((element) => {
                        const animation = element.dataset.animation;
                        gsap.to(element, {
                            duration: 1,
                            opacity: 1,
                            ease: "power4.out",
                            delay: 1.5,
                        });
                    });

                gsap.to(".btn", {
                    duration: 0.3,
                    scale: 1.02,
                    ease: "power4.inOut",
                    stagger: 0.1,
                    repeat: -1,
                    yoyo: true,
                });

                const ratingSlider = document.getElementById("ratingSlider");
                const commentsInput = document.getElementById("commentsInput");
                const evaluationChart = document
                    .getElementById("evaluationChart")
                    .getContext("2d");

                let evaluationData = {
                    labels: ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"],
                    datasets: [
                        {
                            data: [],
                            backgroundColor: "#f8fcff",
                            borderColor: "#eefaf3",
                            borderWidth: 1,
                        },
                    ],
                };

                const evaluationChartOptions = {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false,
                        },
                        tooltip: {
                            enabled: false,
                        },
                    },
                };

                let chartInstance;

                ratingSlider.addEventListener("input", () => {
                    const currentRating = ratingSlider.value;
                    evaluationData.datasets[0].data = [
                        currentRating,
                        10 - currentRating,
                    ];
                    if (!chartInstance) {
                        chartInstance = new Chart(evaluationChart, {
                            type: "radialGradient",
                            data: evaluationData,
                            options: evaluationChartOptions,
                        });
                    } else {
                        chartInstance.data.datasets[0].data = [
                            currentRating,
                            10 - currentRating,
                        ];
                        chartInstance.update();
                    }
                });

                commentsInput.addEventListener("input", () => {
                    const currentComments = commentsInput.value;
                    if (
                        currentComments.length >= 50 &&
                        currentComments.length <= 500
                    ) {
                        document.getElementById("commentsInput").style.border =
                            "none";
                    } else {
                        document.getElementById("commentsInput").style.border =
                            "1px solid red";
                    }
                });

                const evaluationForm =
                    document.getElementById("evaluationForm");
                evaluationForm.addEventListener("submit", (e) => {
                    e.preventDefault();
                    const currentRating = ratingSlider.value;
                    const currentComments = commentsInput.value;

                    if (
                        currentComments.length >= 50 &&
                        currentComments.length <= 500
                    ) {
                        // Autoguardado en LocalStorage
                        localStorage.setItem(
                            "evaluationData",
                            JSON.stringify({
                                rating: currentRating,
                                comments: currentComments,
                            }),
                        );

                        // Autoguardado en IndexedDB
                        const request = indexedDB.open(
                            "misjueces-mx-evaluation-db",
                            1,
                        );
                        request.onupgradeneeded = function (event) {
                            const db = event.target.result;
                            if (!db.objectStoreNames.contains("evaluations")) {
                                db.createObjectStore("evaluations", {
                                    keyPath: "id",
                                });
                            }
                        };

                        request.onsuccess = function (event) {
                            const db = event.target.result;
                            const transaction = db.transaction(
                                ["evaluations"],
                                "readwrite",
                            );
                            const objectStore =
                                transaction.objectStore("evaluations");

                            const evaluationDataObject = JSON.parse(
                                localStorage.getItem("evaluationData"),
                            );
                            objectStore.add(evaluationDataObject);
                        };

                        alert("Evaluación enviada exitosamente.");
                    } else {
                        document.getElementById("commentsInput").style.border =
                            "1px solid red";
                    }
                });
            });
        </script>
    </body>
</html>
